<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny CPU: Logic Gate Simulator</title>
    <!-- Tailwind CSS for layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Styling for the Cyberpunk/Tech feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Dark Slate */
            color: #e2e8f0;
        }
        
        .font-mono {
            font-family: 'Fira Code', monospace;
        }

        /* Bit Styling */
        .bit {
            width: 30px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #334155;
            background: #1e293b;
            margin: 2px;
            border-radius: 4px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .bit.one {
            background-color: #0ea5e9; /* Sky Blue */
            color: white;
            border-color: #38bdf8;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }

        .bit.zero {
            color: #64748b;
        }

        .bit.active {
            border-color: #f43f5e; /* Red highlight for current bit being processed */
            transform: scale(1.1);
        }

        /* Logic Gate SVG Styling */
        .gate-path {
            fill: none;
            stroke: #475569;
            stroke-width: 2;
            transition: stroke 0.3s;
        }
        .gate-body {
            fill: #1e293b;
            stroke: #475569;
            stroke-width: 2;
            transition: all 0.3s;
        }
        
        /* Active states for gates */
        .gate-active .gate-body {
            stroke: #22c55e; /* Green */
            fill: #064e3b;
            box-shadow: 0 0 10px #22c55e;
        }
        .wire-active {
            stroke: #22c55e !important;
            stroke-width: 3 !important;
        }

        /* Animations */
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .processing {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-2">Tiny CPU Simulator</h1>
        <p class="text-slate-400">Visualizing 8-bit Arithmetic & Logic Gates</p>
    </header>

    <!-- Main Control Panel -->
    <main class="w-full max-w-4xl bg-slate-800/50 rounded-xl p-6 border border-slate-700 shadow-2xl backdrop-blur-sm">
        
        <!-- Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="flex flex-col">
                <label class="text-sm text-cyan-400 mb-1">Input A (0-99)</label>
                <input type="number" id="inputA" value="12" min="0" max="99" class="bg-slate-900 border border-slate-600 rounded p-2 text-white focus:outline-none focus:border-cyan-500">
            </div>
            
            <div class="flex flex-col">
                <label class="text-sm text-cyan-400 mb-1">Operation</label>
                <select id="operation" class="bg-slate-900 border border-slate-600 rounded p-2 text-white focus:outline-none focus:border-cyan-500">
                    <option value="ADD">ADD (Ripple Carry)</option>
                    <option value="SUB">SUB (2's Complement)</option>
                    <option value="MUL">MUL (Shift & Add)</option>
                </select>
            </div>

            <div class="flex flex-col">
                <label class="text-sm text-cyan-400 mb-1">Input B (0-99)</label>
                <input type="number" id="inputB" value="5" min="0" max="99" class="bg-slate-900 border border-slate-600 rounded p-2 text-white focus:outline-none focus:border-cyan-500">
            </div>

            <div class="flex flex-col justify-end">
                <button onclick="runSimulation()" id="computeBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-2 px-4 rounded transition-all transform hover:scale-105 shadow-lg">
                    Run CPU Cycle
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left Column: Registers -->
            <div class="space-y-6">
                <!-- Register A -->
                <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                    <div class="flex justify-between mb-2">
                        <span class="text-cyan-400 font-mono">REGISTER A</span>
                        <span id="displayValA" class="text-xs text-slate-500">Dec: 0</span>
                    </div>
                    <div id="bitsA" class="flex justify-center font-mono text-sm">
                        <!-- Bits injected by JS -->
                    </div>
                </div>

                <!-- Register B -->
                <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                    <div class="flex justify-between mb-2">
                        <span class="text-cyan-400 font-mono">REGISTER B</span>
                        <span id="displayValB" class="text-xs text-slate-500">Dec: 0</span>
                    </div>
                    <div id="bitsB" class="flex justify-center font-mono text-sm">
                        <!-- Bits injected by JS -->
                    </div>
                </div>

                <!-- Status / Steps Log -->
                <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 h-48 overflow-y-auto">
                    <h3 class="text-cyan-400 font-mono mb-2 border-b border-slate-700 pb-1">CPU LOG</h3>
                    <div id="consoleLog" class="font-mono text-xs text-green-400 space-y-1">
                        <div>> System Ready...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Visual ALU -->
            <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 flex flex-col items-center">
                <h3 class="text-cyan-400 font-mono mb-4">LOGIC GATE VISUALIZER (1 BIT)</h3>
                
                <!-- SVG Logic Gate Diagram (Full Adder) -->
                <!-- A, B, Cin Inputs -> Sum, Cout -->
                <div class="relative w-full max-w-sm aspect-video bg-slate-800 rounded border border-slate-600 p-2">
                    <svg viewBox="0 0 400 250" class="w-full h-full">
                        <!-- Inputs -->
                        <text x="20" y="40" fill="white" font-size="12">A</text>
                        <text x="20" y="100" fill="white" font-size="12">B</text>
                        <text x="20" y="210" fill="white" font-size="12">CarryIn</text>

                        <!-- Wires (Paths) -->
                        <!-- A to XOR1 and AND1 -->
                        <path id="wire_a" d="M 40 40 L 80 40 L 80 140" class="gate-path" /> 
                        <!-- B to XOR1 and AND1 -->
                        <path id="wire_b" d="M 40 100 L 60 100 L 60 60 L 80 60 L 60 100 L 80 160" class="gate-path" />

                        <!-- XOR 1 (Top Left) -->
                        <g id="gate_xor1" transform="translate(80, 20)">
                            <path d="M0,0 Q10,25 0,50 L10,50 L15,50 Q40,25 15,0 L10,0 Z" fill="#1e293b" stroke="currentColor" class="gate-body"/> <!-- Custom shape simplified -->
                            <text x="10" y="30" font-size="10" fill="white">XOR</text>
                        </g>

                        <!-- AND 1 (Bottom Left) -->
                        <g id="gate_and1" transform="translate(80, 130)">
                            <path d="M0,0 L15,0 Q35,25 15,50 L0,50 Z" fill="#1e293b" stroke="currentColor" class="gate-body"/>
                            <text x="5" y="30" font-size="10" fill="white">AND</text>
                        </g>

                        <!-- Wire from XOR1 output -->
                        <path id="wire_xor1_out" d="M 120 45 L 200 45" class="gate-path" />
                        
                        <!-- Wire from CarryIn -->
                        <path id="wire_cin" d="M 60 210 L 200 210 L 200 85" class="gate-path" />

                        <!-- XOR 2 (Right Top) - Produces SUM -->
                        <g id="gate_xor2" transform="translate(200, 30)">
                            <path d="M0,0 Q10,25 0,50 L10,50 L15,50 Q40,25 15,0 L10,0 Z" fill="#1e293b" stroke="currentColor" class="gate-body"/>
                            <text x="10" y="30" font-size="10" fill="white">XOR</text>
                        </g>

                        <!-- AND 2 (Middle) -->
                        <g id="gate_and2" transform="translate(200, 100)">
                            <path d="M0,0 L15,0 Q35,25 15,50 L0,50 Z" fill="#1e293b" stroke="currentColor" class="gate-body"/>
                            <text x="5" y="30" font-size="10" fill="white">AND</text>
                        </g>

                        <!-- Wire: XOR1_out connects to AND2 input -->
                        <path id="wire_xor1_to_and2" d="M 160 45 L 160 115 L 200 115" class="gate-path" />
                        <!-- Wire: Cin connects to AND2 input -->
                        <path id="wire_cin_to_and2" d="M 180 210 L 180 135 L 200 135" class="gate-path" />

                        <!-- Wire from AND1 out -->
                        <path id="wire_and1_out" d="M 115 155 L 270 155 L 270 180" class="gate-path" />
                        <!-- Wire from AND2 out -->
                        <path id="wire_and2_out" d="M 235 125 L 270 125 L 270 160" class="gate-path" />

                        <!-- OR Gate (Right Bottom) - Produces Carry Out -->
                        <g id="gate_or" transform="translate(270, 150)">
                             <path d="M0,0 Q10,25 0,50 Q40,25 0,0" fill="none" stroke="transparent"/> <!-- spacer -->
                             <path d="M0,0 Q15,25 0,50 L10,50 Q45,25 10,0 Z" fill="#1e293b" stroke="currentColor" class="gate-body"/>
                            <text x="10" y="30" font-size="10" fill="white">OR</text>
                        </g>

                        <!-- Outputs -->
                        <path id="wire_sum" d="M 240 55 L 350 55" class="gate-path" />
                        <text x="360" y="60" fill="#38bdf8" font-weight="bold">SUM</text>

                        <path id="wire_cout" d="M 315 175 L 350 175" class="gate-path" />
                        <text x="360" y="180" fill="#f43f5e" font-weight="bold">C-OUT</text>

                    </svg>
                    
                    <div class="absolute top-2 right-2 text-xs text-slate-500 bg-slate-900/80 p-1 rounded">
                        Active Bit Index: <span id="activeBitIndex" class="text-white font-bold">-</span>
                    </div>
                </div>

                <div class="mt-4 w-full">
                    <div class="flex justify-between mb-2">
                        <span class="text-green-400 font-mono font-bold">FINAL RESULT</span>
                        <span id="displayValResult" class="text-xs text-slate-500">Dec: 0</span>
                    </div>
                    <div id="bitsResult" class="flex justify-center flex-wrap font-mono text-sm">
                        <!-- Result Bits -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-slate-500 text-sm">
        <p>Ripple Carry • 2's Complement • Shift-Add Logic</p>
    </footer>

    <script>
        // --- CONSTANTS & STATE ---
        const DELAY_MS = 800; // Speed of animation
        let isRunning = false;

        // --- UTILITIES ---

        // Convert number to array of bits (Least Significant Bit at index 0)
        function toBinArray(num, bits = 8) {
            let bin = [];
            for (let i = 0; i < bits; i++) {
                bin.push((num >> i) & 1);
            }
            return bin; // [bit0, bit1, bit2...]
        }

        // Convert bit array back to number
        function fromBinArray(arr) {
            let num = 0;
            for (let i = 0; i < arr.length; i++) {
                if (arr[i] === 1) num += Math.pow(2, i);
            }
            return num;
        }

        // Handle 2's complement for display logic if we wanted negative support
        // But for this simplified demo, we treat outputs as standard integers 
        // unless subtraction goes negative.

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function log(msg) {
            const el = document.getElementById('consoleLog');
            const line = document.createElement('div');
            line.innerText = `> ${msg}`;
            el.appendChild(line);
            el.scrollTop = el.scrollHeight;
        }

        // --- UI RENDERING ---

        function renderRegister(elementId, bitArray, activeIndex = -1) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            // Display bits in reverse order (MSB on left, LSB on right) for human reading
            for (let i = bitArray.length - 1; i >= 0; i--) {
                const bitVal = bitArray[i];
                const div = document.createElement('div');
                div.className = `bit ${bitVal ? 'one' : 'zero'} ${i === activeIndex ? 'active' : ''}`;
                div.innerText = bitVal;
                container.appendChild(div);
            }
        }

        function resetGateVisuals() {
            // Remove active classes from all SVG elements
            document.querySelectorAll('.gate-active').forEach(el => el.classList.remove('gate-active'));
            document.querySelectorAll('.wire-active').forEach(el => el.classList.remove('wire-active'));
            document.getElementById('activeBitIndex').innerText = '-';
        }

        // Visualize the Full Adder Logic
        function updateGateVisuals(a, b, cin) {
            resetGateVisuals();

            // Inputs
            if (a) document.getElementById('wire_a').classList.add('wire-active');
            if (b) document.getElementById('wire_b').classList.add('wire-active');
            if (cin) document.getElementById('wire_cin').classList.add('wire-active');

            // Gate Logic Calculations
            const xor1 = a ^ b;
            const and1 = a & b;
            const and2 = xor1 & cin;
            const sum = xor1 ^ cin;
            const cout = and1 | and2;

            // Light up wires and gates based on flow
            
            // XOR 1 Path
            if (a || b) document.getElementById('gate_xor1').classList.add('gate-active');
            if (xor1) {
                document.getElementById('wire_xor1_out').classList.add('wire-active');
                document.getElementById('wire_xor1_to_and2').classList.add('wire-active');
            }

            // AND 1 Path
            if (a && b) {
                document.getElementById('gate_and1').classList.add('gate-active');
                document.getElementById('wire_and1_out').classList.add('wire-active');
            }

            // AND 2 Path
            if (xor1 && cin) {
                document.getElementById('wire_cin_to_and2').classList.add('wire-active');
                document.getElementById('gate_and2').classList.add('gate-active');
                document.getElementById('wire_and2_out').classList.add('wire-active');
            }

            // XOR 2 (Sum) Path
            if (xor1 || cin) document.getElementById('gate_xor2').classList.add('gate-active');
            if (sum) document.getElementById('wire_sum').classList.add('wire-active');

            // OR (Cout) Path
            if (and1 || and2) {
                document.getElementById('gate_or').classList.add('gate-active');
                document.getElementById('wire_cout').classList.add('wire-active');
            }
        }

        // --- SIMULATION LOGIC ---

        async function runSimulation() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('computeBtn').disabled = true;
            document.getElementById('consoleLog').innerHTML = ''; // Clear log
            resetGateVisuals();

            // Get Inputs
            let valA = parseInt(document.getElementById('inputA').value) || 0;
            let valB = parseInt(document.getElementById('inputB').value) || 0;
            const op = document.getElementById('operation').value;

            // Clamp inputs
            valA = Math.min(99, Math.max(0, valA));
            valB = Math.min(99, Math.max(0, valB));

            // Update Input Displays
            let bitsA = toBinArray(valA, 8);
            let bitsB = toBinArray(valB, 8);
            
            renderRegister('bitsA', bitsA);
            renderRegister('bitsB', bitsB);
            document.getElementById('displayValA').innerText = `Dec: ${valA}`;
            document.getElementById('displayValB').innerText = `Dec: ${valB}`;

            log(`Starting ${op} Operation...`);
            log(`Fetching A: ${bitsA.slice().reverse().join('')}`);
            log(`Fetching B: ${bitsB.slice().reverse().join('')}`);

            await sleep(500);

            let resultBits = [];
            let resultVal = 0;

            if (op === 'ADD') {
                resultBits = await simulateRippleCarryAdder(bitsA, bitsB);
                resultVal = fromBinArray(resultBits);
            } else if (op === 'SUB') {
                // 2's Complement Logic: Invert B and Add 1
                log("Calculating 2's Complement of B...");
                
                // Step 1: Invert
                let invertedB = bitsB.map(b => b ? 0 : 1);
                renderRegister('bitsB', invertedB); // Show inversion
                log("B Inverted (1's Comp)");
                await sleep(1000);

                // Step 2: Add 1 (We use the adder logic for this internally or cheat slightly for setup)
                // For visual clarity, we will pass Inverted B + CarryIn=1 to the adder
                log("Setting Carry-In = 1 for Subtraction");
                resultBits = await simulateRippleCarryAdder(bitsA, invertedB, 1);
                
                // Interpret Result for subtraction
                // If the result is technically negative in 8-bit, it shows large number.
                // Simple Display Logic:
                resultVal = valA - valB; // Use JS math for the Decimal display to avoid confusing the user with signed binary complexity
            } else if (op === 'MUL') {
                resultBits = await simulateMultiplication(bitsA, bitsB);
                resultVal = fromBinArray(resultBits);
            }

            // Final Output
            renderRegister('bitsResult', resultBits);
            document.getElementById('displayValResult').innerText = `Dec: ${resultVal}`;
            log(`Operation Complete. Result: ${resultVal}`);
            resetGateVisuals();

            isRunning = false;
            document.getElementById('computeBtn').disabled = false;
        }

        async function simulateRippleCarryAdder(bitsA, bitsB, initialCarry = 0) {
            let carry = initialCarry;
            let sumBits = new Array(8).fill(0);

            for (let i = 0; i < 8; i++) {
                document.getElementById('activeBitIndex').innerText = i;
                renderRegister('bitsA', bitsA, i);
                
                // Subtraction modifies B visually before this, but if we are just adding:
                // We keep B highlighted
                const currentB = document.getElementById('bitsB').children[7-i].classList.contains('one') ? 1 : 0; 
                // We grab directly from DOM for B to respect the Inversion visual in Subtraction
                
                // Highlight current bit in B register (visual only)
                const domBitsB = document.getElementById('bitsB').children;
                Array.from(domBitsB).forEach(el => el.classList.remove('active'));
                domBitsB[7-i].classList.add('active');

                const a = bitsA[i];
                const b = currentB;

                // Logic Gate Calculation
                const sum = (a ^ b) ^ carry;
                const nextCarry = (a & b) | ((a ^ b) & carry);

                // Visualize
                updateGateVisuals(a, b, carry);
                log(`Bit ${i}: ${a} + ${b} + Cin(${carry}) = Sum ${sum}, Cout ${nextCarry}`);

                sumBits[i] = sum;
                
                // Update Result register progressively
                renderRegister('bitsResult', sumBits, i);

                await sleep(DELAY_MS);
                carry = nextCarry;
            }
            return sumBits;
        }

        async function simulateMultiplication(bitsA, bitsB) {
            // Simplified visualization of Shift-and-Add
            // Because full binary multiplication takes many steps, we will show
            // the accumulation of partial products.
            
            let accumulator = new Array(16).fill(0); // Need more space for mul
            let tempA = [...bitsA, 0,0,0,0,0,0,0,0]; // Extend to 16 bits

            renderRegister('bitsResult', accumulator);

            for (let i = 0; i < 8; i++) {
                // Highlight Bit B[i]
                renderRegister('bitsB', bitsB, i);
                
                if (bitsB[i] === 1) {
                    log(`Bit B[${i}] is 1: Adding shifted A to Accumulator`);
                    
                    // Show the shift visually by updating the "Gate" area to show an ADD op
                    // We won't run the full adder animation 8 times (too slow), 
                    // instead we flash the addition result.
                    
                    let shiftedA = new Array(16).fill(0);
                    // Manually shift A by i positions
                    for(let k=0; k<8; k++) {
                        if(bitsA[k]) shiftedA[k+i] = 1;
                    }

                    // Perform addition logic in JS for the accumulator
                    let carry = 0;
                    for(let j=0; j<16; j++) {
                        let bitA = shiftedA[j];
                        let bitAcc = accumulator[j];
                        let sum = bitA ^ bitAcc ^ carry;
                        carry = (bitA & bitAcc) | ((bitA ^ bitAcc) & carry);
                        accumulator[j] = sum;
                    }
                    
                    renderRegister('bitsResult', accumulator);
                    await sleep(DELAY_MS);
                } else {
                    log(`Bit B[${i}] is 0: Skipping`);
                    await sleep(DELAY_MS / 2);
                }
            }
            return accumulator;
        }

    </script>
</body>
</html>
